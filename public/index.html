<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Music Locator</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #searchButton {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-size: 16px;
            border: none;
            cursor: pointer;
            margin-top: 20px;
        }
        #searchButton:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Live Music Locator</h1>
    <form id="searchForm">
        <label for="date_from">Date From:</label>
        <input type="date" id="date_from" name="date_from" required>
        <label for="date_to">Date To:</label>
        <input type="date" id="date_to" name="date_to" required>
        <label for="style">Select Style:</label>
        <select id="style" name="style">
            <option value="styles1.css">Style 1</option>
            <option value="styles2.css">Style 2</option>
            <option value="facebook">Paste to Facebook</option>
        </select>
        <label for="timezone">Select Timezone:</label>
        <select id="timezone" name="timezone">
            <option value="Australia/Sydney">AEST</option>
            <option value="Australia/Adelaide">ACST</option>
            <option value="Australia/Perth">AWST</option>
        </select>
        <fieldset>
            <legend>Select Data Elements:</legend>
            <label><input type="checkbox" name="elements" value="name" checked> Name</label>
            <label><input type="checkbox" name="elements" value="venue" checked> Venue</label>
            <label><input type="checkbox" name="elements" value="address" checked> Address</label>
            <label><input type="checkbox" name="elements" value="time" checked> Time</label>
            <label><input type="checkbox" name="elements" value="description" checked> Description</label>
        </fieldset>
        <button id="searchButton" type="button" onclick="fetchGigs()">Search</button>
    </form>

    <h2>Copy and paste your own gig guide. You can filter by venue or postcode.</h2>
    <h2 id="date-range"></h2>
    
    <label for="filter">Filter by Postcode/Suburb or Venue:</label>
    <select id="filter" onchange="filterGigs()">
        <option value="All">All</option>
    </select>

    <div id="gig-list"></div>

    <script>
        const apiUrl = "https://api.lml.live/gigs/query"; // Adjust API endpoint as needed
        const postcodeApiUrl = 'http://v0.postcodeapi.com.au/suburbs/'; // Postcode API URL
        let gigs = [];
        let postcodes = {}; // This will hold cached postcodes
        let venues = new Set();

        async function fetchPostcode(postcode) {
            if (postcodes[postcode]) {
                return postcodes[postcode];
            }
            try {
                const response = await fetch(`${postcodeApiUrl}${postcode}.json`, {
                    headers: { 'Accept': 'application/json; indent=4' }
                });
                const data = await response.json();
                const suburb = data[0].name;
                postcodes[postcode] = suburb;
                return suburb;
            } catch (error) {
                console.error(`Failed to fetch postcode data for ${postcode}:`, error);
                return 'Unknown Suburb';
            }
        }

        async function fetchGigs() {
            const dateFrom = $('#date_from').val();
            const dateTo = $('#date_to').val();
            const style = $('#style').val();
            const timezone = $('#timezone').val();
            const elements = $('input[name="elements"]:checked').map(function() { return this.value; }).get();

            const url = `${apiUrl}?location=melbourne&date_from=${dateFrom}&date_to=${dateTo}`;
            $.get(url, async function(data) {
                gigs = data;
                await processGigs();
                populateFilters();
                displayGigs(elements, style, timezone);
            });
        }

        async function processGigs() {
            for (const gig of gigs) {
                const venue = gig.venue || {};
                const address = venue.address || '';
                const postcode = address.split(' ').pop();
                if (postcode && !isNaN(postcode)) {
                    postcodes[postcode] = await fetchPostcode(postcode);
                }
                venues.add(venue.name);
            }
        }

        function populateFilters() {
            const filterSelect = $("#filter");
            filterSelect.empty();
            filterSelect.append(`<option value="All">All</option>`);
            for (const [postcode, suburb] of Object.entries(postcodes)) {
                filterSelect.append(`<option value="${postcode}">${postcode} - ${suburb}</option>`);
            }
            venues.forEach(venue => {
                filterSelect.append(`<option value="${venue}">${venue}</option>`);
            });
        }

        function displayGigs(elements, style, timezone, filteredGigs = gigs) {
            const gigList = $("#gig-list");
            gigList.empty();
            let currentDate = null;
            let groupedGigs = {};

            filteredGigs.forEach(gig => {
                const date = new Date(gig.date);
                const formattedDate = date.toDateString();

                if (!groupedGigs[formattedDate]) {
                    groupedGigs[formattedDate] = [];
                }
                groupedGigs[formattedDate].push(gig);
            });

            for (const [date, gigs] of Object.entries(groupedGigs)) {
                gigList.append(`<h2>${date}</h2>`);
                gigs.forEach(gig => {
                    const name = gig.name && elements.includes('name') ? gig.name : '';
                    const venue = gig.venue || {};
                    const venueName = venue.name && elements.includes('venue') ? venue.name : '';
                    const address = venue.address && elements.includes('address') ? venue.address : '';
                    const locationUrl = venue.location_url || '#';
                    const time = gig.start_time && elements.includes('time') ? new Date(gig.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                    const description = gig.description && elements.includes('description') ? gig.description : '';

                    let formattedGig = `
                        <div class="gig">
                            ${name ? `<div class="gig-name">${name}</div>` : ''}
                            ${venueName ? `<div class="gig-venue"><a href="${locationUrl}">${venueName}</a></div>` : ''}
                            ${address ? `<div class="gig-address">${address}</div>` : ''}
                            ${time ? `<div class="gig-time">${time}</div>` : ''}
                            ${description ? `<div class="gig-description">${description}</div>` : ''}
                        </div>
                    `;

                    if (style === 'facebook') {
                        formattedGig = `
                            ${name ? `<b>${name}</b><br>` : ''}
                            ${venueName ? `<a href="${locationUrl}">${venueName}</a><br>` : ''}
                            ${address ? `${address}<br>` : ''}
                            ${time ? `${time}<br>` : ''}
                            ${description ? `${description}<br><br>` : ''}
                        `;
                    }

                    gigList.append(formattedGig);
                });
            }
        }

        function filterGigs() {
            const filterValue = $("#filter").val();
            const elements = $('input[name="elements"]:checked').map(function() { return this.value; }).get();
            const style = $('#style').val();
            const timezone = $('#timezone').val();

            if (filterValue === "All") {
                displayGigs(elements, style, timezone);
            } else {
                const filteredGigs = gigs.filter(gig => {
                    const venue = gig.venue || {};
                    const address = venue.address || '';
                    const postcode = address.split(' ').pop();
                    return venue.name === filterValue || postcode === filterValue;
                });
                displayGigs(elements, style, timezone, filteredGigs);
            }
        }

        $(document).ready(function() {
            fetchGigs();
        });
    </script>
</body>
</html>
